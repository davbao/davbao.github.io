<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"davbao.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="花开堪折直须折，莫待无花空折枝">
<meta property="og:type" content="website">
<meta property="og:title" content="davbao博客">
<meta property="og:url" content="https://davbao.github.io/index.html">
<meta property="og:site_name" content="davbao博客">
<meta property="og:description" content="花开堪折直须折，莫待无花空折枝">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="davbao">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://davbao.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>davbao博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">davbao博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Java攻城狮</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">3</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">2</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">2</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://davbao.github.io/2021/10/14/JAVA%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="davbao">
      <meta itemprop="description" content="花开堪折直须折，莫待无花空折枝">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="davbao博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/14/JAVA%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E4%B8%80/" class="post-title-link" itemprop="url">JAVA线上问题排查-机器内存上涨</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-14 21:06:20" itemprop="dateCreated datePublished" datetime="2021-10-14T21:06:20+08:00">2021-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-15 10:34:36" itemprop="dateModified" datetime="2021-10-15T10:34:36+08:00">2021-10-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/" itemprop="url" rel="index"><span itemprop="name">线上问题</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>问题的缘起是今年中秋值班期间，公司服务端报警群在当天下午16:00出现很多消息队列消息堆积告警，起初以为是服务抖动，可能过一会自行恢复。但是没想到过了几分钟后消息告警有增无减，此时意识到线上服务可能有问题，于是立马打开电脑查看监控，发现消息队列里的消息堆积从16:00以后开始阶梯式的往上涨。从消息队列的监控还可以看到topic共有8个partitionId，其中0，1，2，4分区的消息堆积最多（通过消费者的offsetLag标记判断），而其他分区没有消息堆积。什么原因呢？消费者部署在两台机器上，服务启动的时候，每台机器上的消费者只能固定消费其中4个Partition，服务重新部署的时候，才会触发再次分配。所以基本可以推断，其中一台服务器应该有异常，查看监控发现服务器内存几乎满载，奇怪的是机器并没有发出任何告警。由于服务器上部署的都是离线作业，同时为了快速恢复线上服务能力，因此主管联系了SRE对机器进行了重启（哈哈，实际上是因为中秋节，所以并没有深究问题发生的根源），问题恢复。不过，几天后，同样的问题再次出现……</p>
<p><img src="https://picbao-1306303949.cos.ap-nanjing.myqcloud.com/markdown/image-20211015100023364.png" alt="image-20211015100023364"></p>
<h3 id="初步排查"><a href="#初步排查" class="headerlink" title="初步排查"></a>初步排查</h3><p>由于这块业务是刚刚接手，业务的历史根源还没有完全梳理清楚，因此在排查问题的过程中，困难重重。</p>
<p>首先登陆到机器上，通过<code>free -h</code>查看机器内存状况，发现内存已经所剩无几，<code>top</code>命令查看服务器CPU状况，结果并没有发现特别占用cpu的java服务，但是<code>top</code>命令展示的最后一列<code>COMMAND</code>却有很多java，虽然每个几乎都不占CPU，但是却占有一定的<code>MEM</code>，粗略算了一下所占内存，和出现问题后机器内存上涨保持一致。</p>
<p>但是为啥会有这么多java服务呢？于是命令<code>ps -ef | grep java</code>查看服务，发现同一个java应用竟然被启动了多次，启动次数和上一次机器重启间隔天数一致，也就是说同一个java应用每天都会启动在一个新的进程上，而上一次启动的进程并没有退出。</p>
<p>回到项目代码中查看java服务的启动方式，发现服务是通过cron表达式走系统调度的方式进行启动，这里也可以在服务器上执行<code>cat /etc/crontab /etc/cron.d/*</code>列出机器上所有的定时任务来验证，结果发现这台机器不愧是专门提供给离线作业使用的，密密麻麻的列出了很多定时任务。</p>
<p>回到线上服务器，找到一个没有正常退出的java进程，执行<code>jstat -gcutil 29602 2000</code>看看gc情况</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">S0   S1   E   O   M   CCS  YGC   YGCT  FGC  FGCT   GCT  </span><br><span class="line"></span><br><span class="line"> <span class="number">0</span>.<span class="number">00</span>  <span class="number">0.00 68.84</span>  <span class="number">2.09 98.06</span> <span class="number">92</span>.<span class="number">95</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">018</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">044</span>  <span class="number">0</span>.<span class="number">062</span></span><br><span class="line"></span><br><span class="line"> <span class="number">0</span>.<span class="number">00</span>  <span class="number">0.00 68.84</span>  <span class="number">2.09 98.06</span> <span class="number">92</span>.<span class="number">95</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">018</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">044</span>  <span class="number">0</span>.<span class="number">062</span></span><br><span class="line"></span><br><span class="line"> <span class="number">0</span>.<span class="number">00</span>  <span class="number">0.00 68.84</span>  <span class="number">2.09 98.06</span> <span class="number">92</span>.<span class="number">95</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">018</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">044</span>  <span class="number">0</span>.<span class="number">062</span></span><br><span class="line"></span><br><span class="line"> <span class="number">0</span>.<span class="number">00</span>  <span class="number">0.00 68.84</span>  <span class="number">2.09 98.06</span> <span class="number">92</span>.<span class="number">95</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">018</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">044</span>  <span class="number">0</span>.<span class="number">062</span></span><br><span class="line"></span><br><span class="line"> <span class="number">0</span>.<span class="number">00</span>  <span class="number">0.00 68.84</span>  <span class="number">2.09 98.06</span> <span class="number">92</span>.<span class="number">95</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">018</span>   <span class="number">1</span>  <span class="number">0</span>.<span class="number">044</span>  <span class="number">0</span>.<span class="number">062</span></span><br><span class="line">省略重复</span><br></pre></td></tr></table></figure>

<p>从gc上看，并没有发现任何问题，只能说这个java服务已经处于假死状态。</p>
<p>难道死锁了，于是执行<code>jstack -l -F 29602</code> 查看</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">jstack</span> -l -F <span class="number">29602</span></span><br><span class="line"><span class="attribute">Attaching</span> to process ID <span class="number">29602</span>, please wait...</span><br><span class="line"><span class="attribute">Debugger</span> attached successfully.</span><br><span class="line"><span class="attribute">Server</span> compiler detected.</span><br><span class="line"><span class="attribute">JVM</span> version is <span class="number">25</span>.<span class="number">202</span>-b<span class="number">08</span></span><br><span class="line"><span class="attribute">Deadlock</span> Detection:</span><br><span class="line"></span><br><span class="line"><span class="attribute">No</span> deadlocks found.</span><br></pre></td></tr></table></figure>

<p>疑问脸？！</p>
<p>执行<code>jstack -l 29602</code>查看线程堆栈，看看老哥到底发生了什么鬼？</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">10</span>-<span class="number">14</span> <span class="number">19</span>:<span class="number">51</span>:<span class="number">43</span></span><br><span class="line">Full thread dump OpenJDK <span class="number">64</span>-Bit Server VM (<span class="number">25.202</span>-b08 mixed mode):</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Attach Listener&quot;</span> #<span class="number">37</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f7364001000 nid=<span class="number">0</span>xea1e waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;DestroyJavaVM&quot;</span> #<span class="number">36</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c021000 nid=<span class="number">0</span>x73a6 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;cluster-ClusterId&#123;value=&#x27;6167109337dd8773a2bd3892&#x27;, description=&#x27;null&#x27;&#125;-127.0.0.1:28000&quot;</span> #<span class="number">30</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f7310029800 nid=<span class="number">0</span>x741d waiting on condition <span class="selector-attr">[0x00007f73dc3d2000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: TIMED_WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x0000000080027470&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.parkNanos</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">215</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span><span class="selector-class">.awaitNanos</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2078</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.waitForSignalOrTimeout</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">229</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.waitForNext</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">210</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.run</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">157</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x000000008003e9e8&gt; (<span class="selector-tag">a</span> com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;cluster-ClusterId&#123;value=&#x27;6167109337dd8773a2bd3892&#x27;, description=&#x27;null&#x27;&#125;-127.0.0.1:28000&quot;</span> #<span class="number">29</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f7310027800 nid=<span class="number">0</span>x741c waiting on condition <span class="selector-attr">[0x00007f73dc453000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: TIMED_WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x0000000080017ab8&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.parkNanos</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">215</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span><span class="selector-class">.awaitNanos</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2078</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.waitForSignalOrTimeout</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">229</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.waitForNext</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">210</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.run</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">157</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x0000000080017af0&gt; (<span class="selector-tag">a</span> com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;cluster-ClusterId&#123;value=&#x27;6167109337dd8773a2bd3892&#x27;, description=&#x27;null&#x27;&#125;-127.0.0.1:28000&quot;</span> #<span class="number">28</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f7310026000 nid=<span class="number">0</span>x741b waiting on condition <span class="selector-attr">[0x00007f73dc4d4000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: TIMED_WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x000000008001fa60&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.parkNanos</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">215</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span><span class="selector-class">.awaitNanos</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2078</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.waitForSignalOrTimeout</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">229</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.waitForNext</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">210</span>)</span><br><span class="line">	at com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span><span class="selector-class">.run</span>(DefaultServerMonitor<span class="selector-class">.java</span>:<span class="number">157</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x000000008001fa98&gt; (<span class="selector-tag">a</span> com<span class="selector-class">.mongodb</span><span class="selector-class">.internal</span><span class="selector-class">.connection</span>.DefaultServerMonitor<span class="variable">$ServerMonitorRunnable</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CleanCursors-1-thread-1&quot;</span> #<span class="number">27</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740d9c2000 nid=<span class="number">0</span>x741a waiting on condition <span class="selector-attr">[0x00007f73dc755000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: TIMED_WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x0000000080027738&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.parkNanos</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">215</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span><span class="selector-class">.awaitNanos</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2078</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ScheduledThreadPoolExecutor<span class="variable">$DelayedWorkQueue</span><span class="selector-class">.take</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1093</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ScheduledThreadPoolExecutor<span class="variable">$DelayedWorkQueue</span><span class="selector-class">.take</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">809</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.getTask</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1074</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1134</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor<span class="variable">$Worker</span><span class="selector-class">.run</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">624</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;AsyncAppender-Dispatcher-Thread-0&quot;</span> #<span class="number">22</span> daemon prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740d730800 nid=<span class="number">0</span>x73e3 <span class="keyword">in</span> Object<span class="selector-class">.wait</span>() <span class="selector-attr">[0x00007f73dd7f3000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (on <span class="selector-tag">object</span> monitor)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Native Method)</span><br><span class="line">	- waiting on &lt;<span class="number">0</span>x000000008002e3a0&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span>.ArrayList)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Object<span class="selector-class">.java</span>:<span class="number">502</span>)</span><br><span class="line">	at org<span class="selector-class">.apache</span><span class="selector-class">.log4j</span>.AsyncAppender<span class="variable">$Dispatcher</span><span class="selector-class">.run</span>(AsyncAppender<span class="selector-class">.java</span>:<span class="number">548</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x000000008002e3a0&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span>.ArrayList)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;periodCheckingTmpFileExecutor&quot;</span> #<span class="number">21</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740d70d800 nid=<span class="number">0</span>x73d3 waiting on condition <span class="selector-attr">[0x00007f73dd874000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: TIMED_WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x0000000080036380&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.parkNanos</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">215</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span><span class="selector-class">.awaitNanos</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2078</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ScheduledThreadPoolExecutor<span class="variable">$DelayedWorkQueue</span><span class="selector-class">.take</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1093</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ScheduledThreadPoolExecutor<span class="variable">$DelayedWorkQueue</span><span class="selector-class">.take</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">809</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.getTask</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1074</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1134</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor<span class="variable">$Worker</span><span class="selector-class">.run</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">624</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;periodCheckingRotateExecutor&quot;</span> #<span class="number">20</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740d70c000 nid=<span class="number">0</span>x73d2 waiting on condition <span class="selector-attr">[0x00007f73dd8f5000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: TIMED_WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x000000008003e340&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.parkNanos</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">215</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span><span class="selector-class">.awaitNanos</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2078</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ScheduledThreadPoolExecutor<span class="variable">$DelayedWorkQueue</span><span class="selector-class">.take</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1093</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ScheduledThreadPoolExecutor<span class="variable">$DelayedWorkQueue</span><span class="selector-class">.take</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">809</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.getTask</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1074</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1134</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor<span class="variable">$Worker</span><span class="selector-class">.run</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">624</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;forceMmapExecutor&quot;</span> #<span class="number">19</span> prio=<span class="number">5</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740d70a800 nid=<span class="number">0</span>x73d1 waiting on condition <span class="selector-attr">[0x00007f73dd976000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (parking)</span><br><span class="line">	at sun<span class="selector-class">.misc</span><span class="selector-class">.Unsafe</span><span class="selector-class">.park</span>(Native Method)</span><br><span class="line">	- parking to wait <span class="keyword">for</span>  &lt;<span class="number">0</span>x00000000800462c8&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span><span class="selector-class">.LockSupport</span><span class="selector-class">.park</span>(LockSupport<span class="selector-class">.java</span>:<span class="number">175</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.locks</span>.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span><span class="selector-class">.await</span>(AbstractQueuedSynchronizer<span class="selector-class">.java</span>:<span class="number">2039</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.LinkedBlockingQueue</span><span class="selector-class">.take</span>(LinkedBlockingQueue<span class="selector-class">.java</span>:<span class="number">442</span>)</span><br><span class="line">	at com<span class="selector-class">.mycompany</span><span class="selector-class">.infra</span><span class="selector-class">.galaxy</span><span class="selector-class">.lcs</span><span class="selector-class">.monitor</span><span class="selector-class">.lib</span>.MonitorRecordWriter<span class="variable">$ForceMmapTask</span><span class="selector-class">.run</span>(MonitorRecordWriter<span class="selector-class">.java</span>:<span class="number">388</span>)</span><br><span class="line">	at com<span class="selector-class">.mycompany</span><span class="selector-class">.infra</span><span class="selector-class">.galaxy</span><span class="selector-class">.lcs</span><span class="selector-class">.common</span><span class="selector-class">.tools</span>.NormalThreadManager<span class="variable">$LoggerRunnable</span><span class="selector-class">.run</span>(NormalThreadManager<span class="selector-class">.java</span>:<span class="number">39</span>)</span><br><span class="line">	at com<span class="selector-class">.twitter</span><span class="selector-class">.common</span><span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.TaskConverter$<span class="number">1</span><span class="selector-class">.run</span>(TaskConverter<span class="selector-class">.java</span>:<span class="number">32</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.Executors<span class="variable">$RunnableAdapter</span><span class="selector-class">.call</span>(Executors<span class="selector-class">.java</span>:<span class="number">511</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.FutureTask</span><span class="selector-class">.run</span>(FutureTask<span class="selector-class">.java</span>:<span class="number">266</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ScheduledThreadPoolExecutor<span class="variable">$ScheduledFutureTask</span>.access$<span class="number">201</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">180</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ScheduledThreadPoolExecutor<span class="variable">$ScheduledFutureTask</span><span class="selector-class">.run</span>(ScheduledThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">293</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1149</span>)</span><br><span class="line">	at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor<span class="variable">$Worker</span><span class="selector-class">.run</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">624</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- &lt;<span class="number">0</span>x00000000800614a0&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor<span class="variable">$Worker</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Service Thread&quot;</span> #<span class="number">17</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c112000 nid=<span class="number">0</span>x73c9 runnable <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C1 CompilerThread11&quot;</span> #<span class="number">16</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c10e800 nid=<span class="number">0</span>x73c8 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C1 CompilerThread10&quot;</span> #<span class="number">15</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c10c800 nid=<span class="number">0</span>x73c7 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C1 CompilerThread9&quot;</span> #<span class="number">14</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c10a000 nid=<span class="number">0</span>x73c6 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C1 CompilerThread8&quot;</span> #<span class="number">13</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c108000 nid=<span class="number">0</span>x73c5 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread7&quot;</span> #<span class="number">12</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c106000 nid=<span class="number">0</span>x73c4 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread6&quot;</span> #<span class="number">11</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c103800 nid=<span class="number">0</span>x73c3 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread5&quot;</span> #<span class="number">10</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c101800 nid=<span class="number">0</span>x73c2 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread4&quot;</span> #<span class="number">9</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0f7000 nid=<span class="number">0</span>x73c1 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread3&quot;</span> #<span class="number">8</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0f5000 nid=<span class="number">0</span>x73c0 waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread2&quot;</span> #<span class="number">7</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0f2800 nid=<span class="number">0</span>x73bf waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread1&quot;</span> #<span class="number">6</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0f1000 nid=<span class="number">0</span>x73be waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;C2 CompilerThread0&quot;</span> #<span class="number">5</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0ee000 nid=<span class="number">0</span>x73bd waiting on condition <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Signal Dispatcher&quot;</span> #<span class="number">4</span> daemon prio=<span class="number">9</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0ec000 nid=<span class="number">0</span>x73bc runnable <span class="selector-attr">[0x0000000000000000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: RUNNABLE</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Finalizer&quot;</span> #<span class="number">3</span> daemon prio=<span class="number">8</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0b9800 nid=<span class="number">0</span>x73bb <span class="keyword">in</span> Object<span class="selector-class">.wait</span>() <span class="selector-attr">[0x00007f73edb31000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (on <span class="selector-tag">object</span> monitor)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Native Method)</span><br><span class="line">	- waiting on &lt;<span class="number">0</span>x000000008002e558&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.lang</span><span class="selector-class">.ref</span>.ReferenceQueue<span class="variable">$Lock</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.ReferenceQueue</span><span class="selector-class">.remove</span>(ReferenceQueue<span class="selector-class">.java</span>:<span class="number">144</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x000000008002e558&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.lang</span><span class="selector-class">.ref</span>.ReferenceQueue<span class="variable">$Lock</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.ReferenceQueue</span><span class="selector-class">.remove</span>(ReferenceQueue<span class="selector-class">.java</span>:<span class="number">165</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span>.Finalizer<span class="variable">$FinalizerThread</span><span class="selector-class">.run</span>(Finalizer<span class="selector-class">.java</span>:<span class="number">216</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Reference Handler&quot;</span> #<span class="number">2</span> daemon prio=<span class="number">10</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0b7000 nid=<span class="number">0</span>x73ba <span class="keyword">in</span> Object<span class="selector-class">.wait</span>() <span class="selector-attr">[0x00007f73edbb2000]</span></span><br><span class="line">   java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.State</span>: WAITING (on <span class="selector-tag">object</span> monitor)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Native Method)</span><br><span class="line">	- waiting on &lt;<span class="number">0</span>x0000000080060b28&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.lang</span><span class="selector-class">.ref</span>.Reference<span class="variable">$Lock</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.Object</span><span class="selector-class">.wait</span>(Object<span class="selector-class">.java</span>:<span class="number">502</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span><span class="selector-class">.Reference</span><span class="selector-class">.tryHandlePending</span>(Reference<span class="selector-class">.java</span>:<span class="number">191</span>)</span><br><span class="line">	- locked &lt;<span class="number">0</span>x0000000080060b28&gt; (<span class="selector-tag">a</span> java<span class="selector-class">.lang</span><span class="selector-class">.ref</span>.Reference<span class="variable">$Lock</span>)</span><br><span class="line">	at java<span class="selector-class">.lang</span><span class="selector-class">.ref</span>.Reference<span class="variable">$ReferenceHandler</span><span class="selector-class">.run</span>(Reference<span class="selector-class">.java</span>:<span class="number">153</span>)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">	- None</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;VM Thread&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c0ad000 nid=<span class="number">0</span>x73b9 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#0 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c037000 nid=<span class="number">0</span>x73a7 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#1 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c039000 nid=<span class="number">0</span>x73a8 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#2 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c03a800 nid=<span class="number">0</span>x73a9 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#3 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c03c800 nid=<span class="number">0</span>x73aa runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#4 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c03e000 nid=<span class="number">0</span>x73ab runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#5 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c040000 nid=<span class="number">0</span>x73ac runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#6 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c042000 nid=<span class="number">0</span>x73ad runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#7 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c043800 nid=<span class="number">0</span>x73ae runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#8 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c045800 nid=<span class="number">0</span>x73af runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#9 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c047800 nid=<span class="number">0</span>x73b0 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#10 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c049000 nid=<span class="number">0</span>x73b1 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#11 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c04b000 nid=<span class="number">0</span>x73b2 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#12 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c04d000 nid=<span class="number">0</span>x73b3 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#13 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c04e800 nid=<span class="number">0</span>x73b4 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#14 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c050800 nid=<span class="number">0</span>x73b5 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#15 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c052000 nid=<span class="number">0</span>x73b6 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#16 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c054000 nid=<span class="number">0</span>x73b7 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;GC task thread#17 (ParallelGC)&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c056000 nid=<span class="number">0</span>x73b8 runnable </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;VM Periodic Task Thread&quot;</span> os_prio=<span class="number">0</span> tid=<span class="number">0</span>x00007f740c114800 nid=<span class="number">0</span>x73ca waiting on condition </span><br><span class="line"></span><br><span class="line">JNI global references: <span class="number">243</span></span><br></pre></td></tr></table></figure>

<p>备注：为了隐私安全，上述堆栈信息中，mongodb的集群地址被统一替换成127.0.0.1，公司名被替换成了mycompany</p>
<p>首先映入眼帘的就是mongodb，回想起当初线上问题发生时，查看代码版本变化其中的一个记录就是其他组的同事更新了mongodb的连接，此时我喜出望外以为终于破案了，便兴冲冲的去吃午饭了。但是有些问题还需要再解决，为什么这几天离线作业跑的也没问题？如果连接有问题，那又要怎么改呢，升级mogodb版本，还是把连接切到旧的？带着这些问题，下午我看了代码中关于mongodb的连接部分，最后发现项目配置了两个mogondb的集群，而我们发生问题的java应用并没有去连接修改后的那个集群，这个后来从项目执行的日志里也可以看到JAVA应用确实连的是另一个集群连接，也就是和修改集群连接没有关系。这里也可以部署修改mongodb连接这个版本的代码进行观察，发现进程是可以正常退出的。</p>
<p>难道是因为项目中离线作业连接的hive在执行hive sql结束的时候连接没有释放成功导致的僵死？于是增加日志继续观察，结果发现JAVA执行完业务逻辑后最后回到了main方法体，但是进程没有退出。</p>
<h3 id="对比排查"><a href="#对比排查" class="headerlink" title="对比排查"></a>对比排查</h3><p>现在完全可以断定就是改代码导致的，但是需要定位到是哪里的问题，只能对比排查了。（这个项目里糅合了很多java应用，不同的JAVA应用可能是其他同事负责，如果其他人为了实现某个功能修改代码，此时另一个应用再次部署的时候就可能出问题）</p>
<p>通过对比master和进程正常退出的代码版本（这里的技巧是优先对比pom文件和项目其他资源文件的变化），发现另一个同事在pom文件里引入了公司内部的日志框架以及增加了<code>log4j</code>.xml文件，线程堆栈里<code>AsyncAppender.java:548</code>这个类就是在log4j.xml文件里引入的。而堆栈里<code>periodCheckingRotateExecutor</code>和<code>periodCheckingTmpFileExecutor</code>这两个线程也通过咨询日志那边负责的同事了解到是用来定时收集数据做质量监控的。</p>
<p>绕了一大圈，终于找到了问题的根源，实际上一开始从<code>jstack -l 29602</code>打出的堆栈信息时就应该能定位到问题的根源了。最后既然我们的消费作业实际已经执行完了，只是引入的日志框架中还存在定时线程为正常关闭，那么就可以在main函数的<code>finally</code>代码块加上<code>System.exit(0)</code>退出进程，最终问题解决。</p>
<p>最后，同一项目其他java应用部署没有问题，是因为其他的java应用并不是走的系统调度，每次服务重启的时候，之前的服务进程会退出，然后重新部署，而这个Java应用出问题，还是因为通过系统cron调度的方式起来的，一旦项目里存在非守护的定时线程没有关闭，那么main方法结束后，程序也不会退出的，应用占有的内存资源也就无法得到释放。</p>
<h3 id="本地模拟"><a href="#本地模拟" class="headerlink" title="本地模拟"></a>本地模拟</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ScheduledExecutorService service = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Task worker = <span class="keyword">new</span> Task(<span class="string">&quot;task-&quot;</span> + <span class="number">0</span>);</span><br><span class="line">        service.scheduleAtFixedRate(worker, <span class="number">0</span> ,<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        ThreadGroup threadGroup = Thread.currentThread().getThreadGroup();</span><br><span class="line">        <span class="comment">//activeCount()返回当前正在活动的线程的数量</span></span><br><span class="line">        <span class="keyword">int</span> total = Thread.activeCount();</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[total];</span><br><span class="line">        <span class="comment">//enumerate(threads)将当前线程组中的active线程全部复制到传入的线程数组threads中</span></span><br><span class="line">        <span class="comment">//并且返回数组中元素个数，即线程组中active线程数量</span></span><br><span class="line">        threadGroup.enumerate(threads);</span><br><span class="line">        <span class="keyword">for</span> (Thread t:threads)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;线程&quot;</span>+t.getId()+<span class="string">&quot; &quot;</span>+t.getName()+<span class="string">&quot; &quot;</span>+t.isDaemon());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//service.shutdownNow();</span></span><br><span class="line">        System.out.println(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Task</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Task</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;I&#x27;m living&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行上述代码，发现main结束后，进程也不会正常退出。执行<code>jstack -l pid</code>，可以发现堆栈信息和项目里那个堆栈信息基本一致，如果解除<code>service.shutdown()</code>的注释，程序就可以正常结束了。</p>
<blockquote>
<p><strong>版权申明: 本站博文如非注明转载则均属作者原创文章，引用或转载请注明出处，谢谢。</strong></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://davbao.github.io/2021/09/20/%E5%9F%BA%E4%BA%8EDocker%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BAMySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/123.jpg">
      <meta itemprop="name" content="davbao">
      <meta itemprop="description" content="花开堪折直须折，莫待无花空折枝">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="davbao博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/20/%E5%9F%BA%E4%BA%8EDocker%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BAMySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">基于Docker快速搭建MySQL主从复制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-09-20 22:38:23 / 修改时间：22:54:41" itemprop="dateCreated datePublished" datetime="2021-09-20T22:38:23+08:00">2021-09-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>每次想要学习一门技术时，总是苦于环境的搭建，往往第一步环境搭建就让人心烦意乱，最终丧失学习的兴趣。例如，早些年如果想要深入学习mysql，当遇到不同MySQL版本使用方式的对比时，只能下载不同版本的MySQL版本，然后分别安装，如果再碰到网络不佳等等诸多因素，等最后成功安装往往大半天的时间就过去了。最后技术可能没学好，倒是各种软件的安装熟悉了不少。哈哈，说多了都是泪，当年我就是这么一步一步踩坑过来的。今天，我们使用新的方式——Docker，基于Docker快速搭建MySQL主从复制。</p>
<p><strong>步骤</strong></p>
<ol>
<li><p>首先根据计算机操作系统（mac、window、ubuntu等），安装好该操作系统下的docker</p>
</li>
<li><p>编写安装mysql的master和slave节点的docker文件编排</p>
<p>2.1 在主机合适的地方新建mysql文件夹，文件名随意</p>
<p>2.2 在mysql文件路径下，新建mysql-cluster文件夹，用于存放后续master和slave的相关数据</p>
<p>2.3 在mysql文件路径下，新建docker-compose-mysql-cluster.yml文件，文件名随意</p>
<p>2.4 编辑docker-compose-mysql-cluster.yml文件，内容如下</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line">  mysql-master:</span><br><span class="line"><span class="symbol">    image:</span> mysql:<span class="number">5.7</span></span><br><span class="line"><span class="symbol">    container_name:</span> mysql-master</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - MYSQL_ROOT_PASSWORD=root</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">&quot;3309:3306&quot;</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="string">&quot;./mysql-cluster/master/my.cnf:/etc/my.cnf&quot;</span></span><br><span class="line">      - <span class="string">&quot;./mysql-cluster/master/data:/var/lib/mysql&quot;</span></span><br><span class="line"><span class="symbol">    links:</span></span><br><span class="line">      - mysql-slave</span><br><span class="line">      </span><br><span class="line">  mysql-slave:</span><br><span class="line"><span class="symbol">    image:</span> mysql:<span class="number">5.7</span></span><br><span class="line"><span class="symbol">    container_name:</span> mysql-slave</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - MYSQL_ROOT_PASSWORD=root</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="string">&quot;3310:3306&quot;</span></span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - <span class="string">&quot;./mysql-cluster/slave/my.cnf:/etc/my.cnf&quot;</span></span><br><span class="line">      - <span class="string">&quot;./mysql-cluster/slave/data:/var/lib/mysql&quot;</span></span><br></pre></td></tr></table></figure>

<p>其中，mysql-master和mysql-slave表示节点名称；image表示pull的版本，可以通过<code>docker search mysql</code>来查看具体有哪些版本；environment配置环境运行时的一些信息，例如密码；ports是端口映射配置，冒号前面的表示宿主机的端口，后面的表示容器中mysql运行的实际端口，例如3309:3306即表示当访问主机3309端口时，最后被映射到容器中的mysql的3306端口；volumes配置的是文件之间的映射关系，同样冒号前端的为宿主机的文件路径然后映射到冒号后面的容器中的文件路径；link表示将mysql-slave容器的ip记录到该容器中, 再通过连接 mysql-slave:3306 可以访问数据库。</p>
</li>
<li><p>配置master的配置文件my.cnf</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># [必须]启用二进制日志</span></span><br><span class="line"><span class="attr">log-bin</span>=mysql-bin </span><br><span class="line"><span class="comment"># [必须]服务器唯一ID，默认是1，一般取IP最后一段  </span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">## 复制过滤：可以指定哪个数据库不用同步（mysql库一般不同步）</span></span><br><span class="line"><span class="attr">binlog-ignore-db</span>=mysql</span><br></pre></td></tr></table></figure></li>
<li><p>配置slave的配置文件my.cnf</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># [必须]服务器唯一ID，默认是1，同一局域网中，该值不能重复，一般取IP最后一段  </span></span><br><span class="line"><span class="attr">server-id</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure></li>
<li><p>启动docker-compose，使用<code>docker ps</code>查看进程</p>
<p>在mysql文件路径下执行<code>docker-compose -f docker-compose-mysql-cluster.yml up -d</code></p>
<p>docker ps查看进程</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">CONTAINER</span> ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES</span><br><span class="line"><span class="attribute">5d14a405624d</span>        mysql:<span class="number">5</span>.<span class="number">7</span>           <span class="string">&quot;docker-entrypoint.s…&quot;</span>   <span class="number">7</span> hours ago         Up <span class="number">7</span> hours          <span class="number">33060</span>/tcp, <span class="number">0.0.0.0:3309</span>-&gt;<span class="number">3306</span>/tcp   mysql-master</span><br><span class="line"><span class="attribute">d1e0687850fb</span>        mysql:<span class="number">5</span>.<span class="number">7</span>           <span class="string">&quot;docker-entrypoint.s…&quot;</span>   <span class="number">7</span> hours ago         Up <span class="number">7</span> hours          <span class="number">33060</span>/tcp, <span class="number">0.0.0.0:3310</span>-&gt;<span class="number">3306</span>/tcp   mysql-slave</span><br></pre></td></tr></table></figure></li>
<li><p>配置主从复制</p>
<p>6.1 配置master</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#进入mysql-master容器节点</span></span><br><span class="line">docker exec -it mysql-<span class="keyword">master</span> <span class="title">bash</span></span><br><span class="line"><span class="comment">#进入容器后，就可以把该容器想象成一个仅安装了mysql服务的计算机，命令连接mysql服务，然后输入密码，即yml文件中的配置密码</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="comment">#创建同步用户并设置同步用户权限</span></span><br><span class="line">create <span class="keyword">user</span> <span class="title">repl</span>;</span><br><span class="line">GRANT REPLICATION <span class="literal">SLAVE</span> ON *.* TO &#x27;repl&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;repl&#x27;;</span><br><span class="line"><span class="comment">#显示master的状态，并记录File和Position的值，在配置slave的时候会用到</span></span><br><span class="line">show <span class="keyword">master</span> <span class="title">status</span>;</span><br></pre></td></tr></table></figure>

<p>6.2 配置slave</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment">#进入mysql-slave容器节点</span></span><br><span class="line">docker exec -it mysql-slave bash</span><br><span class="line"><span class="comment">#进入容器后，同样将该容器想象成仅安装了mysql服务的计算机，命令连接mysql服务，然后输入密码，即yml文件中的配置密码</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"><span class="comment">#配置master的参数，注意此处用到6.1配置master中的File和Position的值</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span> <span class="attribute">MASTER_HOST</span>=<span class="string">&#x27;mysql-master&#x27;</span>, <span class="attribute">MASTER_USER</span>=<span class="string">&#x27;repl&#x27;</span>, MASTER_PASSWORD = <span class="string">&#x27;repl&#x27;</span>, MASTER_LOG_FILE = <span class="string">&#x27;mysql-bin.000003&#x27;</span>, MASTER_LOG_POS = 635;</span><br><span class="line"><span class="comment">#启动slave服务</span></span><br><span class="line">start slave;</span><br><span class="line"><span class="comment">#显示slave的状态，注意Slave_IO_Running和Slave_SQL_Running两个必须都是yes，才说明是成功的</span></span><br><span class="line">show slave status\G;</span><br></pre></td></tr></table></figure></li>
<li><p>验证主从复制</p>
</li>
</ol>
<p>使用navicat分别连接mysql-master和mysql-slave，然后在mysql-master节点创建数据库<code>create database test;</code>然后到mysql-slave中查看<code>show databases</code>，可以看到test库已经被同步过来，是不是很神奇？！接下来就可以用java写一些demo测试了。</p>
<p><strong>最后</strong></p>
<p>如果哪天不想用了，或者装错了，就直接使用docker命令把容器关掉，把镜像删掉，如果安装时做了文件映射，就把文件也删了，就当啥也没发生过，非常快捷方便。</p>
<blockquote>
<p><strong>版权申明: 本站博文如非注明转载则均属作者原创文章，引用或转载请注明出处，谢谢。</strong></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="davbao"
      src="/images/123.jpg">
  <p class="site-author-name" itemprop="name">davbao</p>
  <div class="site-description" itemprop="description">花开堪折直须折，莫待无花空折枝</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">davbao</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
